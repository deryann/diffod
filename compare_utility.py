
# test_data
# lst_r_1 = [{'x1': 353.0, 'x2': 518.0, 'y1': 1257.0, 'y2': 1482.0, 'conf': 0.69091797, 'label': 'bird'}, {'x1': 2577.0, 'x2': 2747.0, 'y1': 140.0, 'y2': 405.0, 'conf': 0.6533203, 'label': 'bird'}, {'x1': 60.0, 'x2': 221.0, 'y1': 1401.0, 'y2': 1588.0, 'conf': 0.5292969, 'label': 'bird'}, {'x1': 4024.0, 'x2': 4191.0, 'y1': 1999.0, 'y2': 2209.0, 'conf': 0.5234375, 'label': 'bird'}, {'x1': 376.0, 'x2': 526.0, 'y1': 246.0, 'y2': 480.0, 'conf': 0.5136719, 'label': 'bird'}, {'x1': 1848.0, 'x2': 2029.0, 'y1': 1541.0, 'y2': 1802.0, 'conf': 0.49414062, 'label': 'bird'}, {'x1': 932.0, 'x2': 1080.0, 'y1': 1509.0, 'y2': 1770.0, 'conf': 0.47460938, 'label': 'bird'}, {'x1': 3028.0, 'x2': 3195.0, 'y1': 2022.0, 'y2': 2229.0, 'conf': 0.47460938, 'label': 'bird'}, {'x1': 3128.0, 'x2': 3289.0, 'y1': 1646.0, 'y2': 1827.0, 'conf': 0.4416504, 'label': 'bird'}, {'x1': 2858.0, 'x2': 3008.0, 'y1': 779.0, 'y2': 959.0, 'conf': 0.43969727, 'label': 'bird'}, {'x1': 3366.0, 'x2': 3553.0, 'y1': 2049.0, 'y2': 2270.0, 'conf': 0.4243164, 'label': 'bird'}, {'x1': 694.0, 'x2': 849.0, 'y1': 29.0, 'y2': 256.0, 'conf': 0.41870117, 'label': 'bird'}, {'x1': 2614.0, 'x2': 2761.0, 'y1': 683.0, 'y2': 884.0, 'conf': 0.40551758, 'label': 'bird'}, {'x1': 3854.0, 'x2': 4001.0, 'y1': 2168.0, 'y2': 2351.0, 'conf': 0.40161133, 'label': 'bird'}, {'x1': 1938.0, 'x2': 2086.0, 'y1': 928.0, 'y2': 1168.0, 'conf': 0.38671875, 'label': 'bird'}, {'x1': 2169.0, 'x2': 2316.0, 'y1': 1462.0, 'y2': 1678.0, 'conf': 0.38305664, 'label': 'bird'}, {'x1': 1151.0, 'x2': 1288.0, 'y1': 904.0, 'y2': 1048.0, 'conf': 0.3540039, 'label': 'bird'}, {'x1': 3676.0, 'x2': 3837.0, 'y1': 2149.0, 'y2': 2333.0, 'conf': 0.3540039, 'label': 'bird'}, {'x1': 1557.0, 'x2': 1701.0, 'y1': 2214.0, 'y2': 2395.0, 'conf': 0.34326172, 'label': 'bird'}, {'x1': 1932.0, 'x2': 2086.0, 'y1': 574.0, 'y2': 803.0, 'conf': 0.34155273, 'label': 'bird'}, {'x1': 1241.0, 'x2': 1421.0, 'y1': 663.0, 'y2': 902.0, 'conf': 0.33276367, 'label': 'bird'}, {'x1': 2538.0, 'x2': 2692.0, 'y1': 1147.0, 'y2': 1337.0, 'conf': 0.3310547, 'label': 'bird'}, {'x1': 1355.0, 'x2': 1522.0, 'y1': 1142.0, 'y2': 1434.0, 'conf': 0.3173828, 'label': 'bird'}, {'x1': 1589.0, 'x2': 1743.0, 'y1': 263.0, 'y2': 522.0, 'conf': 0.30908203, 'label': 'bird'}, {'x1': 692.0, 'x2': 846.0, 'y1': 729.0, 'y2': 946.0, 'conf': 0.30078125, 'label': 'bird'}, {'x1': 2243.0, 'x2': 2386.0, 'y1': 906.0, 'y2': 1100.0, 'conf': 0.27661133, 'label': 'bird'}, {'x1': 1081.0, 'x2': 1222.0, 'y1': 430.0, 'y2': 587.0, 'conf': 0.27368164, 'label': 'bird'}, {'x1': 1583.0, 'x2': 1736.0, 'y1': 860.0, 'y2': 1060.0, 'conf': 0.27368164, 'label': 'bird'}, {'x1': 1591.0, 'x2': 1733.0, 'y1': 1061.0, 'y2': 1270.0, 'conf': 0.26733398, 'label': 'bird'}, {'x1': 2192.0, 'x2': 2363.0, 'y1': 1087.0, 'y2': 1330.0, 'conf': 0.26586914, 'label': 'bird'}, {'x1': 1228.0, 'x2': 1395.0, 'y1': 2131.0, 'y2': 2402.0, 'conf': 0.26293945, 'label': 'bird'}, {'x1': 1190.0, 'x2': 1350.0, 'y1': 224.0, 'y2': 400.0, 'conf': 0.25097656, 'label': 'bird'}]
# lst_r_2 = [{'x1': 2593.0127, 'x2': 2746.985, 'y1': 129.24805, 'y2': 413.08902, 'conf': 0.77383596, 'label': 'bird'}, {'x1': 354.62518, 'x2': 518.66406, 'y1': 1255.3179, 'y2': 1485.2344, 'conf': 0.6899441, 'label': 'bird'}, {'x1': 61.855984, 'x2': 220.16193, 'y1': 1403.3434, 'y2': 1577.2477, 'conf': 0.57365555, 'label': 'bird'}, {'x1': 376.48328, 'x2': 532.32385, 'y1': 241.04088, 'y2': 484.9071, 'conf': 0.56831646, 'label': 'bird'}, {'x1': 960.71906, 'x2': 1130.0558, 'y1': 2102.3584, 'y2': 2351.9993, 'conf': 0.56327885, 'label': 'bird'}, {'x1': 1851.2982, 'x2': 2027.4183, 'y1': 1541.5355, 'y2': 1803.9353, 'conf': 0.5604107, 'label': 'bird'}, {'x1': 691.71875, 'x2': 842.7698, 'y1': 734.82245, 'y2': 942.7775, 'conf': 0.5591964, 'label': 'bird'}, {'x1': 929.2364, 'x2': 1088.7677, 'y1': 1503.0272, 'y2': 1759.2181, 'conf': 0.55117476, 'label': 'bird'}, {'x1': 1149.987, 'x2': 1285.5427, 'y1': 894.57196, 'y2': 1048.6064, 'conf': 0.5469117, 'label': 'bird'}, {'x1': 1935.148, 'x2': 2087.4778, 'y1': 578.3732, 'y2': 809.42426, 'conf': 0.5406474, 'label': 'bird'}, {'x1': 1227.6957, 'x2': 1400.6765, 'y1': 2125.1042, 'y2': 2397.0674, 'conf': 0.5324038, 'label': 'bird'}, {'x1': 692.9408, 'x2': 856.2036, 'y1': 32.035923, 'y2': 258.0987, 'conf': 0.49336898, 'label': 'bird'}, {'x1': 1568.6346, 'x2': 1690.9225, 'y1': 2212.2693, 'y2': 2400.3174, 'conf': 0.4838447, 'label': 'bird'}, {'x1': 3467.2852, 'x2': 3617.0063, 'y1': 1446.6896, 'y2': 1592.0486, 'conf': 0.47988752, 'label': 'bird'}, {'x1': 1084.1075, 'x2': 1223.9652, 'y1': 426.67538, 'y2': 588.32635, 'conf': 0.45628032, 'label': 'bird'}, {'x1': 1198.23, 'x2': 1346.3584, 'y1': 220.51924, 'y2': 398.84158, 'conf': 0.45149744, 'label': 'bird'}, {'x1': 1937.4312, 'x2': 2092.7295, 'y1': 929.486, 'y2': 1168.9224, 'conf': 0.43211123, 'label': 'bird'}, {'x1': 3850.7812, 'x2': 3994.5452, 'y1': 2168.2043, 'y2': 2347.4263, 'conf': 0.4316078, 'label': 'bird'}, {'x1': 3367.642, 'x2': 3554.0063, 'y1': 2040.3655, 'y2': 2269.4526, 'conf': 0.4300135, 'label': 'bird'}, {'x1': 4026.0894, 'x2': 4183.87, 'y1': 1995.6428, 'y2': 2199.6938, 'conf': 0.4254387, 'label': 'bird'}, {'x1': 2175.9653, 'x2': 2316.6433, 'y1': 1465.9218, 'y2': 1675.0731, 'conf': 0.41463688, 'label': 'bird'}, {'x1': 3032.125, 'x2': 3192.3428, 'y1': 2028.2017, 'y2': 2220.704, 'conf': 0.39762074, 'label': 'bird'}, {'x1': 1259.0542, 'x2': 1421.1288, 'y1': 660.8122, 'y2': 898.3157, 'conf': 0.3975273, 'label': 'bird'}, {'x1': 2398.3062, 'x2': 2547.4204, 'y1': 1484.7141, 'y2': 1696.5521, 'conf': 0.389272, 'label': 'bird'}, {'x1': 3286.9268, 'x2': 3434.9446, 'y1': 1214.863, 'y2': 1428.9597, 'conf': 0.38840216, 'label': 'bird'}, {'x1': 2610.9355, 'x2': 2761.5098, 'y1': 682.96375, 'y2': 884.02814, 'conf': 0.3805738, 'label': 'bird'}, {'x1': 1884.4266, 'x2': 2038.8171, 'y1': 1870.3745, 'y2': 2113.4812, 'conf': 0.349198, 'label': 'bird'}, {'x1': 3126.1704, 'x2': 3293.6636, 'y1': 1641.9783, 'y2': 1812.2356, 'conf': 0.3300691, 'label': 'bird'}, {'x1': 1369.5616, 'x2': 1526.8782, 'y1': 1131.2286, 'y2': 1430.3842, 'conf': 0.30887166, 'label': 'bird'}, {'x1': 2337.4976, 'x2': 2492.1018, 'y1': 2151.7373, 'y2': 2339.9316, 'conf': 0.30716845, 'label': 'bird'}, {'x1': 1583.4293, 'x2': 1735.9664, 'y1': 862.9437, 'y2': 1058.158, 'conf': 0.30531797, 'label': 'bird'}, {'x1': 2857.5208, 'x2': 3003.731, 'y1': 771.86127, 'y2': 940.3569, 'conf': 0.29425806, 'label': 'bird'}, {'x1': 3692.9277, 'x2': 3829.9443, 'y1': 2140.943, 'y2': 2335.4119, 'conf': 0.29270437, 'label': 'bird'}, {'x1': 3046.3184, 'x2': 3275.4153, 'y1': 2310.8635, 'y2': 2483.8928, 'conf': 0.27656484, 'label': 'bird'}, {'x1': 1592.2163, 'x2': 1743.4838, 'y1': 1068.9016, 'y2': 1269.7463, 'conf': 0.27321154, 'label': 'bird'}]

def get_iou(bbox_ai, bbox_gt):
    iou_x = max(bbox_ai[0], bbox_gt[0])  # x
    iou_y = max(bbox_ai[1], bbox_gt[1])  # y
    iou_w = min(bbox_ai[2]+bbox_ai[0], bbox_gt[2]+bbox_gt[0]) - iou_x  # w
    iou_w = max(iou_w, 0)
    # print(f'{iou_w=}')
    iou_h = min(bbox_ai[3]+bbox_ai[1], bbox_gt[3]+bbox_gt[1]) - iou_y  # h
    iou_h = max(iou_h, 0)
    # print(f'{iou_h=}')

    iou_area = iou_w * iou_h
    # print(f'{iou_area=}')
    all_area = bbox_ai[2]*bbox_ai[3] + bbox_gt[2]*bbox_gt[3] - iou_area
    # print(f'{all_area=}')

    return max(iou_area/all_area, 0)


def x1y1x2y2_2_bbox(dic_1):
    return (dic_1['x1'], dic_1['y1'], dic_1['x2']-dic_1['x1'], dic_1['y2']-dic_1['y1'])


def get_iou_x1y1x2y2(dic_1, dic_2):
    return get_iou(x1y1x2y2_2_bbox(dic_1), x1y1x2y2_2_bbox(dic_2))


def get_iou_compare_result(lst_r_1: list, lst_r_2: list):
    r1 = sorted(lst_r_1, key=lambda d: -d['conf'])
    r2 = sorted(lst_r_2, key=lambda d: -d['conf'])

    set1 = {item['label'] for item in r1}
    set2 = {item['label'] for item in r2}

    for label_item in list(set1 | set2):
        for r_item_1 in r1:
            if r_item_1['label'] != label_item:
                    continue
            r_item_1['_max_iou'] = 0
            r_item_1['link'] = None

            for r_item_2 in r2:
                if r_item_2['label'] != label_item:
                    continue
                if r_item_2.get("b_used", None) == 1:
                    continue
                curr_iou = get_iou_x1y1x2y2(r_item_1, r_item_2)
                if curr_iou > r_item_1['_max_iou']:
                    r_item_1['_max_iou'] = curr_iou
                    r_item_1['link'] = r_item_2

            if r_item_1['link'] != None:
                r_item_1['link']['b_used'] = 1
    return r1
